<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hub - AlexiaFlix</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e50914" id="meta-theme-color">

    <!-- Librairies Moteurs : Tailwind, Fuse.js et Lucide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- CHARGEMENT DE LA BASE DE DONNÉES GÉNÉRÉE PAR POWERSHELL A LA RACINE -->
    <script src="./data.js"></script>
    
    <style>
        :root { 
            --color-brand: #e50914; 
            --color-hub: #2563eb; 
            --color-bonus: #a855f7; 
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #080808; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        body {
            background-color: #000;
            color: #fafafa;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
        }

        /* Focus TV */
        .tv-focusable {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            outline: 3px solid transparent;
            position: relative;
            transform-origin: center;
        }
        .tv-focusable.focused, .tv-focusable:hover {
            outline-color: #fff;
            outline-offset: 4px;
            transform: scale(1.04) translateY(-5px);
            z-index: 50;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.9);
        }

        /* SPA Layers */
        .page-layer {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            background: #000;
        }
        .page-layer.active { opacity: 1; pointer-events: auto; }

        .modal-layer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(30px);
            z-index: 300;
            transform: translateY(40px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-layer.active { opacity: 1; pointer-events: auto; transform: translateY(0); }

        .glass-nav {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .shading-overlay {
            background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0.5) 40%, rgba(0,0,0,0) 100%);
        }
        
        .preview-video {
            transition: opacity 1s ease;
            filter: brightness(0.9);
        }

        @keyframes ai-status-pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } }
        .ai-status-dot { animation: ai-status-pulse 2.5s infinite ease-in-out; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col antialiased">

    <!-- Audio Engine -->
    <audio id="audio-click" src="" preload="auto"></audio>
    <audio id="audio-notif" src="" preload="auto"></audio>
    <audio id="audio-open" src="" preload="auto"></audio>

    <!-- 1. AUTHENTICATION -->
    <div id="auth-screen" class="page-layer active z-[500] flex items-center justify-center bg-dark">
        <div class="text-center p-8 md:p-14 bg-[#0a0a0a] rounded-3xl md:rounded-[4rem] border border-white/5 shadow-2xl max-w-sm w-full mx-4 relative overflow-hidden">
            <div class="absolute -top-32 -right-32 w-64 h-64 bg-brand/5 blur-[100px] rounded-full"></div>
            <img id="auth-logo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 150'><rect width='150' height='150' fill='%23e50914'/><text x='75' y='85' fill='white' font-family='sans-serif' font-size='60' font-weight='bold' text-anchor='middle' dominant-baseline='middle'>A</text></svg>" class="w-20 h-20 md:w-28 md:h-28 mx-auto mb-8 rounded-2xl md:rounded-[2.5rem] shadow-2xl object-contain border border-white/10 relative z-10">
            <h1 class="text-3xl md:text-5xl font-black mb-2 tracking-tighter italic uppercase">Alexia Hub</h1>
            <p class="text-neutral-600 mb-10 text-[9px] font-black uppercase tracking-[0.4em]">Identification Requise</p>
            <button id="btn-login" class="tv-focusable w-full bg-white text-black py-4 px-6 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-neutral-200 transition-all uppercase text-[10px] tracking-[0.2em]">
                <i data-lucide="unlock" class="w-4 h-4 text-brand"></i>
                Se connecter
            </button>
        </div>
    </div>

    <!-- 2. MAIN HUB -->
    <div id="main-app" class="page-layer bg-dark">
        <header class="h-20 md:h-28 flex items-center justify-between px-6 md:px-10 bg-gradient-to-b from-black via-black/80 to-transparent z-40 fixed top-0 w-full">
            <div class="flex items-center gap-4 md:gap-6">
                <img id="header-logo" src="" alt="Logo" class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl shadow-2xl border border-white/10 object-contain hidden">
                <div>
                    <h1 id="header-title" class="text-xl md:text-3xl font-black tracking-tighter text-white uppercase italic drop-shadow-2xl">Hub</h1>
                    <div id="ai-status" class="flex items-center gap-1.5 text-[7px] md:text-[8px] text-neutral-600 uppercase font-black tracking-[0.2em] mt-0.5 md:mt-1">
                        <span id="ai-dot" class="w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full border border-white/5"></span>
                        <span id="ai-text">Cluster Synchro</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4 md:gap-6">
                <button class="tv-focusable p-2.5 md:p-3.5 rounded-xl md:rounded-2xl bg-white/5 hover:bg-white/10 text-white backdrop-blur-xl border border-white/5" id="btn-search">
                    <i data-lucide="search" class="w-5 h-5 md:w-6 md:h-6"></i>
                </button>
                <div class="w-10 h-10 md:w-12 md:h-12 rounded-xl md:rounded-2xl bg-neutral-900 overflow-hidden tv-focusable ring-2 ring-transparent focus:ring-brand shadow-2xl border border-white/5" id="profile-btn">
                    <img id="user-avatar" src="" alt="User" class="w-full h-full object-cover hidden">
                    <i data-lucide="user" class="w-full h-full p-2.5 text-neutral-700" id="user-fallback"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-32 pt-24 md:pt-32 px-4 md:px-12 lg:px-20" id="scroll-container">
            <div id="page-hub" class="content-section space-y-12 md:space-y-20 active">
                <!-- HERO SECTION -->
                <div id="hero-banner" class="relative w-full h-[50vh] md:h-[65vh] rounded-3xl md:rounded-[4rem] overflow-hidden tv-focusable group cursor-pointer hidden shadow-2xl">
                    <img id="hero-img" src="" class="w-full h-full object-cover relative z-10 transition-transform duration-[4s] group-hover:scale-110">
                    <video id="hero-video" src="" class="absolute inset-0 w-full h-full object-cover z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-1000 pointer-events-none" muted loop playsinline></video>
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent flex flex-col justify-end p-6 md:p-12 z-30">
                        <span class="bg-brand text-white text-[8px] md:text-[10px] font-black px-3 py-1 md:px-5 md:py-2 rounded-full w-max mb-4 md:mb-8 uppercase tracking-[0.4em] shadow-2xl border border-white/10">Sélection</span>
                        <h2 id="hero-title" class="text-3xl md:text-7xl lg:text-8xl font-black mb-6 md:mb-10 drop-shadow-2xl tracking-tighter uppercase italic leading-none">...</h2>
                        <div class="flex gap-4">
                            <button class="bg-white text-black px-6 py-3 md:px-12 md:py-6 rounded-2xl md:rounded-[2rem] font-black flex items-center gap-3 hover:bg-brand hover:text-white transition-all shadow-2xl uppercase text-[9px] md:text-[11px] tracking-[0.3em]">
                                <i data-lucide="play" class="w-4 h-4 md:w-7 md:h-7 fill-current"></i> Lancer
                            </button>
                        </div>
                    </div>
                </div>

                <!-- GRILLES -->
                <section>
                    <h3 class="text-[9px] md:text-[11px] font-black mb-6 md:mb-10 flex items-center gap-3 uppercase tracking-[0.4em] text-hub italic opacity-50"><i data-lucide="layout-grid" class="w-4 h-4 md:w-5 md:h-5"></i> Mes Applications</h3>
                    <div id="apps-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-10"></div>
                </section>

                <section>
                    <h3 class="text-[9px] md:text-[11px] font-black mb-6 md:mb-10 flex items-center gap-3 uppercase tracking-[0.4em] text-brand italic opacity-50"><i data-lucide="sparkles" class="w-4 h-4 md:w-5 md:h-5"></i> Catalogue Complet</h3>
                    <div id="hub-recent-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-10"></div>
                </section>
            </div>

            <div id="page-films" class="content-section space-y-8 hidden">
                <h2 class="text-4xl md:text-7xl font-black uppercase italic tracking-tighter mb-10 opacity-90 leading-none">Films</h2>
                <div id="films-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-10"></div>
            </div>

            <div id="page-series" class="content-section space-y-8 hidden">
                <h2 class="text-4xl md:text-7xl font-black uppercase italic tracking-tighter mb-10 opacity-90 leading-none">Séries</h2>
                <div id="series-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-10"></div>
            </div>
            
            <div id="page-bonus" class="content-section space-y-8 hidden">
                <h2 class="text-4xl md:text-7xl font-black uppercase italic tracking-tighter text-bonus mb-10 flex items-center gap-4 leading-none"><i data-lucide="gem" class="w-8 h-8 md:w-20 md:h-20"></i> Bonus VIP</h2>
                <div id="bonus-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-10"></div>
            </div>

            <!-- SETUP -->
            <div id="page-settings" class="content-section max-w-3xl mx-auto space-y-10 hidden">
                <h2 class="text-4xl md:text-7xl font-black uppercase italic tracking-tighter mb-12">Setup</h2>
                <div class="bg-[#080808] rounded-3xl md:rounded-[4rem] p-8 md:p-12 border border-white/5 flex flex-col md:flex-row items-center justify-between gap-6 shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-brand/5 to-transparent pointer-events-none"></div>
                    <div class="flex items-center gap-6 md:gap-10 relative z-10">
                        <img id="settings-avatar" src="" alt="Avatar" class="w-24 h-24 md:w-32 md:h-32 rounded-2xl md:rounded-[2.5rem] bg-neutral-900 shadow-2xl border border-white/10 object-cover">
                        <i data-lucide="user" class="w-24 h-24 md:w-32 md:h-32 text-neutral-800" id="settings-avatar-fallback"></i>
                        <div>
                            <h3 class="text-2xl md:text-4xl font-black italic tracking-tighter uppercase mb-2" id="settings-name">Admin</h3>
                            <p class="text-neutral-700 font-mono text-[10px] uppercase tracking-[0.3em]" id="settings-email">Guest Session</p>
                        </div>
                    </div>
                    <button id="btn-logout" class="bg-red-500/10 text-red-500 border border-red-500/20 px-8 py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.3em] hover:bg-red-500 hover:text-white transition-all tv-focusable relative z-10">Logout</button>
                </div>
                <div class="space-y-6">
                    <h4 class="text-neutral-700 font-black uppercase tracking-[0.5em] text-[10px] ml-6">Override graphiques</h4>
                    <div class="bg-[#080808] rounded-3xl md:rounded-[4rem] border border-white/5 p-8 md:p-12 shadow-2xl">
                        <label class="block text-[10px] font-black text-neutral-400 mb-6 uppercase tracking-[0.3em]">Univers Visuel</label>
                        <select id="theme-selector" class="w-full bg-black text-white p-5 md:p-7 rounded-2xl md:rounded-[2rem] outline-none tv-focusable border border-white/5 focus:border-brand appearance-none font-black uppercase text-xs md:text-base tracking-widest cursor-pointer shadow-inner">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                </div>
            </div>
        </main>

        <!-- NAV -->
        <nav class="glass-nav fixed bottom-0 w-full h-20 md:h-32 flex justify-around items-center z-50 px-4 md:px-16">
            <button class="nav-btn tv-focusable flex flex-col items-center gap-1.5 md:gap-3 p-3 md:p-5 w-20 md:w-28 rounded-2xl md:rounded-[2.5rem] text-brand" data-target="page-hub" data-title="Hub"><i data-lucide="layout-grid" class="w-6 h-6 md:w-8 md:h-8"></i><span class="text-[8px] md:text-[10px] font-black uppercase tracking-[0.2em]">Hub</span></button>
            <button class="nav-btn tv-focusable flex flex-col items-center gap-1.5 md:gap-3 p-3 md:p-5 w-20 md:w-28 rounded-2xl md:rounded-[2.5rem] text-neutral-700" data-target="page-films" data-title="Films"><i data-lucide="film" class="w-6 h-6 md:w-8 md:h-8"></i><span class="text-[8px] md:text-[10px] font-black uppercase tracking-[0.2em]">Films</span></button>
            <button class="nav-btn tv-focusable flex flex-col items-center gap-1.5 md:gap-3 p-3 md:p-5 w-20 md:w-28 rounded-2xl md:rounded-[2.5rem] text-neutral-700" data-target="page-series" data-title="Séries"><i data-lucide="tv-2" class="w-6 h-6 md:w-8 md:h-8"></i><span class="text-[8px] md:text-[10px] font-black uppercase tracking-[0.2em]">Séries</span></button>
            <button id="nav-bonus-btn" class="nav-btn tv-focusable items-center gap-1.5 md:gap-3 p-3 md:p-5 w-20 md:w-28 rounded-2xl md:rounded-[2.5rem] text-neutral-700" data-target="page-bonus" data-title="Bonus" style="display: none; flex-direction: column;"><i data-lucide="gem" class="w-6 h-6 md:w-8 md:h-8 text-bonus"></i><span class="text-[8px] md:text-[10px] font-black uppercase tracking-[0.2em] text-bonus">Bonus</span></button>
            <button class="nav-btn tv-focusable flex flex-col items-center gap-1.5 md:gap-3 p-3 md:p-5 w-20 md:w-28 rounded-2xl md:rounded-[2.5rem] text-neutral-700" data-target="page-settings" data-title="Terminal"><i data-lucide="command" class="w-6 h-6 md:w-8 md:h-8"></i><span class="text-[8px] md:text-[10px] font-black uppercase tracking-[0.2em]">Setup</span></button>
        </nav>
    </div>

    <!-- MODAL DETAILS -->
    <div id="series-modal" class="modal-layer">
        <div class="relative w-full h-[40vh] md:h-[55vh] shrink-0 bg-black overflow-hidden">
            <img id="series-modal-bg" src="" class="w-full h-full object-cover opacity-25 absolute inset-0 blur-[60px] scale-150">
            <video id="series-modal-video" src="" class="w-full h-full object-cover opacity-70 absolute inset-0 hidden" autoplay loop muted playsinline></video>
            <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/30 to-transparent"></div>
            <button id="btn-close-series" class="absolute top-6 left-6 md:top-14 md:left-14 tv-focusable p-4 md:p-7 bg-white/5 backdrop-blur-[50px] rounded-2xl md:rounded-[2.5rem] border border-white/10 hover:bg-white/20 transition-all shadow-2xl"><i data-lucide="arrow-left" class="w-8 h-8 md:w-12 md:h-12 text-white"></i></button>
            <div class="absolute bottom-10 left-10 right-10 md:bottom-20 md:left-20 md:right-20"><h2 id="series-modal-title" class="text-4xl md:text-8xl lg:text-9xl font-black mb-6 tracking-tighter uppercase italic drop-shadow-[0_20px_40px_rgba(0,0,0,1)] text-white leading-none">Archives</h2><p id="series-modal-count" class="text-brand font-black uppercase tracking-[0.5em] text-[10px] ml-4 opacity-50">Cluster multimédia synchronisé</p></div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 md:p-16 lg:p-24 bg-dark">
            <div class="max-w-6xl mx-auto">
                <div id="series-seasons-tabs"></div>
                <div id="series-episodes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10"></div>
            </div>
        </div>
    </div>

    <!-- PLAYER -->
    <div id="player-modal" class="modal-layer bg-black justify-center items-center">
        <div class="absolute top-0 left-0 w-full h-24 md:h-36 bg-gradient-to-b from-black to-transparent flex items-center px-8 md:px-16 justify-between z-10">
            <h2 id="player-title" class="text-xl md:text-4xl font-black uppercase italic tracking-tighter text-white drop-shadow-2xl">Streaming Hub</h2>
            <button id="btn-close-player" class="tv-focusable p-4 md:p-7 bg-white/5 backdrop-blur-[50px] rounded-2xl md:rounded-[2.5rem] border border-white/10 shadow-2xl"><i data-lucide="chevron-down" class="w-8 h-8 md:w-10 md:h-10"></i></button>
        </div>
        <video id="main-video-player" class="w-full h-full max-h-screen object-contain outline-none shadow-[0_0_200px_rgba(229,9,20,0.25)]" controls autoplay></video>
    </div>

    <!-- SEARCH -->
    <div id="search-modal" class="modal-layer">
        <div class="h-24 md:h-32 flex items-center gap-6 md:gap-10 px-8 md:px-16 border-b border-white/5 bg-black/40">
            <button id="btn-close-search" class="tv-focusable p-4 rounded-2xl bg-white/5 text-neutral-500"><i data-lucide="x" class="w-6 h-6 md:w-8 md:h-8"></i></button>
            <input type="text" id="search-input" placeholder="SCANNING CLUSTER..." class="w-full bg-transparent text-white text-3xl md:text-7xl font-black italic outline-none placeholder-neutral-900 tracking-tighter uppercase leading-none">
        </div>
        <div class="flex-1 overflow-y-auto p-10 md:p-24">
            <div id="search-results-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-12"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyAMOaSsfswRqfPj_DbgjRYvVfU6ntwd9dk", authDomain: "alexiaflix-a.firebaseapp.com", databaseURL: "https://alexiaflix-a-default-rtdb.europe-west1.firebasedatabase.app", projectId: "alexiaflix-a", storageBucket: "alexiaflix-a.firebasestorage.app", messagingSenderId: "2155057204", appId: "1:2155057204:web:f0a21d8885afab1f957a61" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const AUTHORIZED_BONUS_USERS = ["4GPtbfnXb7cffbWMEBtRATu9xmW2", "P3VWJBUHAHbg0coKSW01t0Lxbjn1", "tT3hSDKpXLOpeuVgy9K3b1hlDfJ3", "IzlFvRu62MSftPlsKlQ7Px881Y52", "b176ANwO9wZLKBrq5pxo8xFMxJv1", "hKbHWNHTABNvVJ42qV3cIEqZ0mz1"];

        const generateSVGPoster = (text) => {
            const safeText = encodeURIComponent(text.substring(0,35).toUpperCase());
            return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='450'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%231a1a1a'/><stop offset='1' stop-color='%23000'/></linearGradient></defs><rect width='300' height='450' fill='url(%23g)'/><rect width='260' height='410' x='20' y='20' rx='30' ry='30' fill='none' stroke='%23ffffff0c' stroke-width='2'/><text x='150' y='225' fill='%23e50914' font-family='Impact, sans-serif' font-size='32' font-weight='900' text-anchor='middle' dominant-baseline='middle' opacity='0.7' letter-spacing='-1.5'>${safeText}</text></svg>`;
        };

        const playSound = (id) => { try { const a = document.getElementById(id); if (a && a.src) { a.currentTime = 0; a.play().catch(() => {}); } } catch (e) {} };
        window.startPreview = (el) => { const v = el.querySelector('video'); if(v) v.play().catch(()=>{}); };
        window.stopPreview = (el) => { const v = el.querySelector('video'); if(v) { v.pause(); v.currentTime = 0; } };

        function applyTheme(tName) {
            const themes = window.alexiaData.themes || {};
            const t = themes[tName]; if (!t) return;
            localStorage.setItem('alexia-theme', tName);
            document.getElementById('audio-click').src = t.sounds?.click || '';
            document.getElementById('audio-notif').src = t.sounds?.notif || '';
            document.getElementById('audio-open').src = t.sounds?.open || '';
            if (t.logo) {
                document.getElementById('auth-logo').src = t.logo;
                document.getElementById('header-logo').src = t.logo; 
                document.getElementById('header-logo').classList.remove('hidden');
                const img = new Image(); img.crossOrigin = "Anonymous"; img.src = t.logo;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d'); c.width = img.width; c.height = img.height;
                    ctx.drawImage(img, 0, 0); const d = ctx.getImageData(0, 0, c.width, c.height).data;
                    let r=0,g=0,b=0,cnt=0; for(let i=0;i<d.length;i+=128){ if(d[i+3]>128){r+=d[i];g+=d[i+1];b+=d[i+2];cnt++;}}
                    const clr = cnt > 0 ? `rgb(${~~(r/cnt)},${~~(g/cnt)},${~~(b/cnt)})` : '#e50914';
                    document.documentElement.style.setProperty('--color-brand', clr); 
                    document.getElementById('meta-theme-color').content = clr;
                };
            }
        }
        document.getElementById('theme-selector').addEventListener('change', (e) => applyTheme(e.target.value));

        onAuthStateChanged(auth, (u) => { 
            if(u) {
                document.getElementById('auth-screen').classList.remove('active');
                document.getElementById('main-app').classList.add('active');
                if(u.photoURL) ['user-avatar','settings-avatar'].forEach(id => { document.getElementById(id).src=u.photoURL; document.getElementById(id).classList.remove('hidden'); });
                document.getElementById('settings-name').textContent = u.displayName || 'Alexia Operator';
                document.getElementById('nav-bonus-btn').style.display = AUTHORIZED_BONUS_USERS.includes(u.uid) ? 'flex' : 'none';
                playSound('audio-open');
                refreshUI();
            } else {
                document.getElementById('main-app').classList.remove('active');
                document.getElementById('auth-screen').classList.add('active');
            }
        });

        function refreshUI() {
            const data = window.alexiaData || { films: [], series: {}, themes: {}, apps: [], bonus: [] };
            
            const ts = document.getElementById('theme-selector');
            ts.innerHTML = '<option value="">Standard Alexia Hub</option>';
            Object.keys(data.themes || {}).forEach(t => ts.innerHTML += `<option value="${t}">${t}</option>`);
            const saved = localStorage.getItem('alexia-theme');
            if(saved && data.themes[saved]) { ts.value = saved; applyTheme(saved); } 
            else if(data.themes['AlexiaFlix - Logo']) applyTheme('AlexiaFlix - Logo');

            renderApps('apps-grid', data.apps || []);
            renderGrid('films-grid', data.films || []);
            renderGrid('series-grid', Object.values(data.series || {}));
            renderGrid('bonus-grid', data.bonus || []);
            
            const standardAll = [...(data.films || []), ...Object.values(data.series || {})];
            renderGrid('hub-recent-grid', standardAll.slice(0, 10));
            
            if(data.films && data.films.length > 0) {
                const h = data.films[0]; 
                document.getElementById('hero-img').src = h.poster || generateSVGPoster(h.title); 
                document.getElementById('hero-title').textContent = h.title;
                const hv = document.getElementById('hero-video');
                if(h.extrait) { 
                    hv.src=h.extrait; 
                    document.getElementById('hero-banner').onmouseenter = () => hv.play().catch(()=>{}); 
                    document.getElementById('hero-banner').onmouseleave = () => { hv.pause(); hv.currentTime=0; }; 
                }
                document.getElementById('hero-banner').classList.remove('hidden'); 
                document.getElementById('hero-banner').onclick = () => playMedia(h.path, h.title);
            }
            setupTVNavigation();
            lucide.createIcons();
        }

        function renderApps(id, list) {
            const c = document.getElementById(id); if(!c) return;
            c.innerHTML = list.map(a => `
                <div class="bg-[#111] rounded-3xl md:rounded-[3rem] p-6 md:p-14 flex flex-col items-center gap-6 md:gap-10 tv-focusable border border-white/5 cursor-pointer shadow-2xl group transition-all" onclick="window.location.href='${a.path}'">
                    <div class="w-16 h-16 md:w-32 md:h-32 bg-hub/10 rounded-2xl md:rounded-[3rem] flex items-center justify-center group-hover:bg-hub transition-all shadow-inner">
                        ${a.icon ? `<img src="${a.icon}" class="w-10 h-10 md:w-20 md:h-20 object-contain">` : `<i data-lucide="layers" class="w-10 h-10 md:w-16 md:h-16 text-hub group-hover:text-white"></i>`}
                    </div>
                    <span class="font-black uppercase tracking-[0.4em] text-[10px] md:text-[12px] text-center opacity-40 group-hover:opacity-100">${a.title}</span>
                </div>
            `).join('');
        }

        function renderGrid(id, items) {
            const c = document.getElementById(id); if(!c) return;
            if(!items || items.length === 0) { c.innerHTML = '<div class="col-span-full py-20 text-neutral-800 text-xs font-black uppercase tracking-[0.5em] text-center opacity-40">Aucun fichier détecté</div>'; return; }
            c.innerHTML = items.map(item => {
                const isS = !!item.episodes;
                const poster = item.poster || generateSVGPoster(item.title);
                const act = isS ? `openSeriesModal('${item.title.replace(/'/g, "\\'")}')` : `playMedia('${item.path}', '${item.title.replace(/'/g, "\\'")}')`;
                return `
                <div class="relative rounded-2xl md:rounded-[4rem] overflow-hidden aspect-[2/3] tv-focusable group bg-[#0d0d0d] border border-white/5 cursor-pointer shadow-2xl transition-all" onclick="${act}" onmouseenter="startPreview(this)" onmouseleave="stopPreview(this)">
                    <img src="${poster}" class="absolute inset-0 w-full h-full object-cover z-10 transition-transform duration-[5s] group-hover:scale-125">
                    ${item.extrait ? `<video src="${item.extrait}" class="preview-video absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 z-20" muted loop playsinline></video>` : ''}
                    <div class="absolute inset-0 shading-overlay opacity-0 group-hover:opacity-100 flex flex-col justify-end p-6 md:p-14 z-30 pointer-events-none transition-all duration-700">
                        <span class="text-white font-black uppercase italic text-lg md:text-3xl lg:text-4xl leading-none tracking-tighter">${item.title}</span>
                        ${isS ? `<span class="text-[9px] md:text-[11px] text-brand font-black uppercase tracking-[0.4em] mt-3 md:mt-5">${item.episodes.length} Épisodes</span>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        window.openSeriesModal = (title) => {
            const d = window.alexiaData;
            let s = (d.series && d.series[title]) || (d.bonus && d.bonus.find(b => b.title === title));
            if(!s) return;
            document.getElementById('series-modal-title').textContent = s.title;
            const sv = document.getElementById('series-modal-video'); const si = document.getElementById('series-modal-bg');
            if(s.extrait) { sv.src=s.extrait; sv.classList.remove('hidden'); si.classList.add('hidden'); sv.play().catch(()=>{}); } 
            else { sv.src=''; sv.classList.add('hidden'); si.src=s.poster || generateSVGPoster(s.title); si.classList.remove('hidden'); }
            
            const seasons = [...new Set(s.episodes.map(e => e.saisonNum))].sort((a,b)=>a-b);
            document.getElementById('series-seasons-tabs').innerHTML = seasons.length > 1 ? `<div class="flex gap-4 md:gap-8 overflow-x-auto pb-6 md:pb-10 mb-8 md:mb-12 hide-scrollbar">${seasons.map((sn, i) => `<button class="tv-focusable px-8 py-4 md:px-16 md:py-8 rounded-2xl md:rounded-[3rem] font-black uppercase text-[10px] md:text-xs tracking-widest ${i===0?'bg-white text-black shadow-2xl':'bg-neutral-900 text-neutral-600'}" onclick="showSeason('${title.replace(/'/g, "\\'")}', ${sn}, this)">Saison ${sn}</button>`).join('')}</div>` : '';
            showSeason(title, seasons[0]); document.getElementById('series-modal').classList.add('active');
        };

        window.showSeason = (title, sn, btn) => {
            const d = window.alexiaData;
            let s = d.series[title] || (d.bonus && d.bonus.find(b => b.title === title));
            if(btn) { btn.parentElement.querySelectorAll('button').forEach(b => { b.classList.remove('bg-white','text-black'); b.classList.add('bg-neutral-900','text-neutral-600'); }); btn.classList.remove('bg-neutral-900','text-neutral-600'); btn.classList.add('bg-white','text-black'); }
            const eps = s.episodes.filter(e => e.saisonNum === sn).sort((a,b) => a.epNum - b.epNum);
            document.getElementById('series-episodes-list').innerHTML = eps.map(e => `
                <div class="bg-[#111] border border-white/5 p-6 md:p-12 rounded-2xl md:rounded-[4rem] flex items-center justify-between tv-focusable cursor-pointer shadow-xl hover:border-brand/50 group transition-all" onclick="playMedia('${e.path}', '${e.title.replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-6 md:gap-10">
                        <div class="w-12 h-12 md:w-20 md:h-20 rounded-xl md:rounded-[2.5rem] bg-brand/10 flex items-center justify-center group-hover:bg-brand transition-all shadow-inner"><i data-lucide="play" class="w-6 h-6 md:w-10 md:h-10 text-brand group-hover:text-white fill-current"></i></div>
                        <span class="font-black uppercase tracking-tighter italic text-sm md:text-2xl lg:text-3xl leading-none">${e.title}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-6 h-6 md:w-10 md:h-10 text-neutral-900 group-hover:text-white group-hover:translate-x-6 transition-all"></i>
                </div>
            `).join('');
            lucide.createIcons(); setupTVNavigation();
        };

        document.getElementById('btn-close-series').addEventListener('click', () => { document.getElementById('series-modal').classList.remove('active'); document.getElementById('series-modal-video').pause(); });
        document.getElementById('btn-close-player').addEventListener('click', () => { const v=document.getElementById('main-video-player'); v.pause(); v.src=""; document.getElementById('player-modal').classList.remove('active'); });
        window.playMedia = (src, t) => { document.getElementById('player-title').textContent = t; const v=document.getElementById('main-video-player'); v.src=src; document.getElementById('player-modal').classList.add('active'); v.play().catch(()=>{}); };

        // NAVIGATION
        const nbs = document.querySelectorAll('.nav-btn');
        nbs.forEach(btn => btn.addEventListener('click', () => {
            playSound('audio-click'); 
            nbs.forEach(b => { b.classList.remove('text-brand', 'text-white'); b.classList.add('text-neutral-700'); });
            btn.classList.remove('text-neutral-700'); btn.classList.add(btn.dataset.target === 'page-bonus' ? 'text-bonus' : (btn.dataset.target === 'page-hub' ? 'text-brand' : 'text-white'));
            document.querySelectorAll('.content-section').forEach(s => { s.classList.add('hidden'); s.classList.remove('active'); if(s.id === btn.dataset.target) { s.classList.remove('hidden'); s.classList.add('active'); } });
            document.getElementById('header-title').textContent = btn.dataset.title; setupTVNavigation();
        }));

        function setupTVNavigation() {
            const fcs = Array.from(document.querySelectorAll('.tv-focusable'));
            fcs.forEach(el => { if(!el.hasAttribute('tabindex')) { el.setAttribute('tabindex', '0'); el.addEventListener('mouseenter', () => { document.querySelectorAll('.tv-focusable.focused').forEach(f => f.classList.remove('focused')); el.classList.add('focused'); el.focus(); }); } });
            document.onkeydown = (e) => {
                const vis = fcs.filter(el => !!(el.offsetWidth || el.offsetHeight) && window.getComputedStyle(el).visibility !== 'hidden');
                if (vis.length === 0) return;
                let cur = vis.findIndex(el => el.classList.contains('focused') || document.activeElement === el); if (cur === -1) cur = 0;
                if (['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp'].includes(e.key)) { e.preventDefault(); playSound('audio-click'); }
                if (e.key === 'ArrowRight') cur = (cur + 1) % vis.length;
                else if (e.key === 'ArrowLeft') cur = (cur - 1 + vis.length) % vis.length;
                else if (e.key === 'ArrowDown') cur = Math.min(cur + 4, vis.length - 1);
                else if (e.key === 'ArrowUp') cur = Math.max(cur - 4, 0);
                else if (e.key === 'Enter' && cur >= 0) { vis[cur].click(); vis[cur].style.transform = 'scale(0.9)'; setTimeout(() => vis[cur].style.transform = '', 150); }
                document.querySelectorAll('.tv-focusable.focused').forEach(f => f.classList.remove('focused'));
                const t = vis[cur]; if(t) { t.classList.add('focused'); t.focus(); t.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            };
        }

        document.getElementById('btn-login').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>